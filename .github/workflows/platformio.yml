# PlatformIO Docker Build Workflow
name: ðŸ³ PlatformIO Docker Image

on:
  push:
    branches: [master, dev]
    paths:
      - '.github/workflows/platformio.yml'
      - 'images/platformio/**'
  pull_request:
    branches: [master, dev]
    paths:
      - '.github/workflows/platformio.yml'
      - 'images/platformio/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jethome-dev-platformio

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
        pio_version: ['6.1.18']
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ðŸ” Log in to GitHub Container Registry
        if: github.ref_name == 'master'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ·ï¸ Prepare platform tag
        id: platform
        run: |
          PLATFORM_PAIR=${{ matrix.platform }}
          PLATFORM_TAG=$(echo $PLATFORM_PAIR | sed 's/\//-/g')
          echo "tag=${PLATFORM_TAG}" >> $GITHUB_OUTPUT
          
      - name: ðŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: images/platformio
          platforms: ${{ matrix.platform }}
          push: ${{ github.ref_name == 'master' }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:pio-${{ matrix.pio_version }}-${{ steps.platform.outputs.tag }}
          cache-from: type=gha,scope=${{ env.IMAGE_NAME }}-${{ steps.platform.outputs.tag }}
          cache-to: type=gha,mode=max,scope=${{ env.IMAGE_NAME }}-${{ steps.platform.outputs.tag }}
          build-args: |
            PIO_VERSION=${{ matrix.pio_version }}

  create-manifest:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref_name == 'master'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        pio_version: ['6.1.18']
    steps:
      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ·ï¸ Generate version and date tags
        id: tags
        run: |
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE_TAG=$(date +%Y.%m.%d)
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "date_tag=${DATE_TAG}" >> $GITHUB_OUTPUT
          
      - name: ðŸŽ¯ Create multi-arch manifest
        run: |
          docker buildx imagetools create -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:stable \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:pio-${{ matrix.pio_version }} \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.date_tag }} \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:sha-${{ steps.tags.outputs.sha_short }} \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:pio-${{ matrix.pio_version }}-linux-amd64 \
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:pio-${{ matrix.pio_version }}-linux-arm64
